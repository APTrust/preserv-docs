
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.7">
    
    
      
        <title>NSQ - APTrust Preservation Services</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#nsq" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="APTrust Preservation Services" class="md-header__button md-logo" aria-label="APTrust Preservation Services" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            APTrust Preservation Services
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              NSQ
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/APTrust/preserv-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="APTrust Preservation Services" class="md-nav__button md-logo" aria-label="APTrust Preservation Services" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    APTrust Preservation Services
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/APTrust/preserv-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../structure/" class="md-nav__link">
        Code Structure
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Components
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Components" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Components
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Components
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../redis/" class="md-nav__link">
        Redis
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          NSQ
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        NSQ
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#duplicate-tasks-in-nsq" class="md-nav__link">
    Duplicate Tasks in NSQ
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queue-settings-in-aws-parameter-store" class="md-nav__link">
    Queue Settings in AWS Parameter Store
  </a>
  
    <nav class="md-nav" aria-label="Queue Settings in AWS Parameter Store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#workers-setting" class="md-nav__link">
    Workers Setting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-size-setting" class="md-nav__link">
    Buffer Size Setting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max-attempts-setting" class="md-nav__link">
    Max Attempts Setting
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fatal-errors" class="md-nav__link">
    Fatal Errors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nsq-admin-functions" class="md-nav__link">
    NSQ Admin Functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manually-requeuing" class="md-nav__link">
    Manually Requeuing
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../registry/" class="md-nav__link">
        Registry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../s3/" class="md-nav__link">
        S3
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Workers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Workers" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Workers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/anatomy/" class="md-nav__link">
        Anatomy of a Worker
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_3">
          Ingest
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ingest" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Ingest
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/ingest/" class="md-nav__link">
        Ingest Workers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/ingest/bucket-reader/" class="md-nav__link">
        The Bucket Reader
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/ingest/pre-fetch/" class="md-nav__link">
        The Metadata Gatherer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/ingest/validator/" class="md-nav__link">
        The Bag Validator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/ingest/reingest-manager/" class="md-nav__link">
        The Reingest Manager
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/ingest/staging-uploader/" class="md-nav__link">
        The Staging Uploader
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/ingest/format-identifier/" class="md-nav__link">
        The Format Identifier
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/ingest/preservation-uploader/" class="md-nav__link">
        The Preservation Uploader
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/ingest/preservation-verifier/" class="md-nav__link">
        The Preservation Verifier
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/ingest/recorder/" class="md-nav__link">
        The Recorder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/ingest/cleanup/" class="md-nav__link">
        Cleanup
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/fixity/" class="md-nav__link">
        Fixity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/restoration/" class="md-nav__link">
        Restoration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workers/deletion/" class="md-nav__link">
        Deletion
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../settings/" class="md-nav__link">
        Settings
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../docker/" class="md-nav__link">
        Docker
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../auditor/" class="md-nav__link">
        Auditor
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#duplicate-tasks-in-nsq" class="md-nav__link">
    Duplicate Tasks in NSQ
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queue-settings-in-aws-parameter-store" class="md-nav__link">
    Queue Settings in AWS Parameter Store
  </a>
  
    <nav class="md-nav" aria-label="Queue Settings in AWS Parameter Store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#workers-setting" class="md-nav__link">
    Workers Setting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-size-setting" class="md-nav__link">
    Buffer Size Setting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#max-attempts-setting" class="md-nav__link">
    Max Attempts Setting
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fatal-errors" class="md-nav__link">
    Fatal Errors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nsq-admin-functions" class="md-nav__link">
    NSQ Admin Functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manually-requeuing" class="md-nav__link">
    Manually Requeuing
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/APTrust/preserv-docs/edit/master/docs/components/nsq.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="nsq">NSQ</h1>
<p>NSQ is the queue service that tells all our workers what tasks need to be completed. This includes ingest, restoration, deletion and fixity workers.</p>
<p>NSQ includes topics and channels. A topic holds a list of tasks that need to be completed. Each topic can have one or more channels. Workers subscribe to channels to get their work.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>NSQ allows multiple channels per topic because in certain environments
mutiple workers need to take action when an item appears in a queue.
In Preserv, we use only one channel per topic.</p>
</div>
<p>In Preserv, each topic has only one channel, and workers subscribe to channels as described in the table below. The <code>source</code> column describes how items get into this queue. The <code>content</code> column describes what's in the queue message. When the content is a WorkItem ID, the worker pulls a copy of the WorkItem from the Registry, marks it as "in progress" and begins its work. When the the content is a GenericFile ID, the worker retrieves the GenericFile record from the Registry, runs a fixity check, and records the outcome in a Premis Event withouth ever creating a WorkItem.</p>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Worker</th>
<th>Content</th>
<th>Purpose</th>
<th>Source</th>
</tr>
</thead>
<tbody>
<tr>
<td>delete_item</td>
<td><a href="/workers/deletion/">apt_delete</a></td>
<td>WorkItem ID</td>
<td>Deletes files and/or objects from preservation storage and records deletion Premis Event.</td>
<td>Deletions are pushed into the queue by the Registry when they're approved by an institutional admin. The apt_queue service runs periodically to catch any deletion and restoration requests that may not have made it from Registry to NSQ due to network errors.</td>
</tr>
<tr>
<td>fixity_check</td>
<td>apt_fixity</td>
<td>GenericFile ID</td>
<td>Tells apt_fixity which files to check.</td>
<td>The apt_queue_fixity process pushes about 2500 files into this queue every 20-30 minutes. The exact number and frequency are defined by params <code>QUEUE_FIXITY_INTERVAL</code> and <code>MAX_FIXITY_ITEMS_PER_RUN</code>, both of which are in AWS Parameter Store.</td>
</tr>
<tr>
<td>ingest01_ prefetch</td>
<td><a href="/workers/ingest/pre-fetch/">ingest _pre_ fetch</a></td>
<td>WorkItem ID</td>
<td>Scans new bags in depositors' receiving buckets and collects metadata for bag validation.</td>
<td>The ingest_bucket_reader, a cron job running in its own container, checks the buckets every few minutes. When it finds new bags with no associated WorkItem, it creates a new Ingest WorkItem in the Registry and pushes the WorkItem ID into this queue.</td>
</tr>
<tr>
<td>ingest02 _bag_ validation</td>
<td><a href="/workers/ingest/validator/">ingest_ validator</a></td>
<td>WorkItem ID</td>
<td>Validates a bag to ensure all files are present, all checksums match, no extraneous payload files exist, and the bag conforms to the BagIt profile noted in bag-info.txt.</td>
<td>The ingest_pre_fetch worker pushes WorkItem IDs into this queue for each item it successfully processes.</td>
</tr>
<tr>
<td>ingest03_ reingest_ check</td>
<td><a href="/workers/ingest/reingest-manager/">reingest_ manager</a></td>
<td>WorkItem ID</td>
<td>Checks files in the bag against known files in the Registry to see if any of them are re-ingests. See the <a href="/workers/ingest/reingest-manager/">reingest manager page</a> for more info.</td>
<td>Filled by ingest_validator.</td>
</tr>
<tr>
<td>ingest04_ staging</td>
<td><a href="/workers/ingest/staging-uploader/">ingest_ staging_ uploader</a></td>
<td>WorkItem ID</td>
<td>Unpacks tarred bags from depositor receiving buckets and uploads the individual files to an S3 staging bucket so subsequent workers can process them.</td>
<td>Filled by reingest_manager.</td>
</tr>
<tr>
<td>ingest05_ format_ identification</td>
<td><a href="/workers/ingest/format-identifier/">ingest_ format_ identifier</a></td>
<td>WorkItem ID</td>
<td>Runs individual files from the staging bucket through the Siegfried file identifier, which uses the PRONOM registry under the hood to identify file formats.</td>
<td>Filled by ingest_ staging_ uploader.</td>
</tr>
<tr>
<td>ingest06_ storage</td>
<td><a href="/workers/ingest/preservation-uploader/">ingest_ preservation_ uploader</a></td>
<td>WorkItem ID</td>
<td>Copies individual files from the S3 staging bucket to preservation storage in S3, Glacier, and/or Wasabi.</td>
<td>Filled by ingest_ format_ identifier.</td>
</tr>
<tr>
<td>ingest07_ storage _validation</td>
<td><a href="/workers/ingest/preservation-verifier/">ingest_ preservation_ verifier</a></td>
<td>WorkItem ID</td>
<td>Verifies that items copied to preservation storage actually got there by performing a HEAD request and ensuring file size matches.</td>
<td>Filled by ingest_ preservation_ uploader.</td>
</tr>
<tr>
<td>ingest08_ record</td>
<td><a href="/workers/ingest/recorder/">ingest_ recorder</a></td>
<td>WorkItem ID</td>
<td>Records the results of an ingest in Registry. This includes the object record, file records, storage records, checksums, and premis events.</td>
<td>Filled by ingest_ preservation_ verifier.</td>
</tr>
<tr>
<td>ingest09_ cleanup</td>
<td><a href="/workers/ingest/cleanup/">ingest_ cleanup</a></td>
<td>WorkItem ID</td>
<td>Deletes interim processing data, including the tarred bag in the depositor's receiving bucket, the individual files in the staging bucket, and the processing metadata in Redis/Elasticache.</td>
<td>Filled by ingest_recorder.</td>
</tr>
<tr>
<td>restore_ file</td>
<td><a href="/workers/restoration/file-restorer/">file_ restorer</a></td>
<td>WorkItem ID</td>
<td>Restores individual files by moving them from preservation storage to the depositor's restoration bucket.</td>
<td>Filled by Registry when a user clicks the <code>Restore File</code> button, with backup from <code>apt_queue</code> in case Registry queueing fails. This topic can also be filled by restore_glacier worker when it determines that a Glacier file has been moved into an S3 bucket for retrieval.</td>
</tr>
<tr>
<td>restore_ glacier</td>
<td><a href="/workers/restoration/glacier-restorer/">glacier_ restorer</a></td>
<td>WorkItem ID</td>
<td>Moves files from Glacier and Glacier Deep Archive into an S3 bucket so they can be restored to depositors.</td>
<td>Filled by Registry when a user clicks the <code>Restore File</code> button for an object in Glacier or Glacier Deep Archive. Registry queueing fails, <code>apt_queue</code> will find the item and queue it.</td>
</tr>
<tr>
<td>restore_ object</td>
<td><a href="/workers/restoration/bag-restorer/">bag_ restorer</a></td>
<td>WorkItem ID</td>
<td>Restores entire objects (bags) to depositors by collecting all files, bagging them, validating the bag, and pushing it into the depositor's restoration bucket.</td>
<td>Filled by Registry when a user clicks the <code>Restore File</code> button, with backup from <code>apt_queue</code> in case Registry queueing fails. This topic can also be filled by restore_glacier worker when it determines that all of a bag's Glacier files have been moved into an S3 bucket for retrieval.</td>
</tr>
</tbody>
</table>
<h2 id="duplicate-tasks-in-nsq">Duplicate Tasks in NSQ</h2>
<p>Under <a href="https://nsq.io/overview/design.html#message-delivery-guarantees" target="_blank">Message Delivery Guarantees</a> NSQ documentation says:</p>
<blockquote>
<p>NSQ guarantees that a message will be delivered at least once, though duplicate messages are possible. Consumers should expect this and de-dupe or perform idempotent operations.</p>
</blockquote>
<p>It's fairly common to get duplicate messages in most of the NSQ topics. This generally happens in two ways:</p>
<ol>
<li>
<p>In the fixity topic, <code>apt_queue_fixity</code> finds 2500 files in the Registry that have not had a fixity check in 90 days. It queues the GenericFile ID of those files in NSQ's <code>fixity_check</code> topic. Occasionally, <code>apt_fixity</code> can't get through all 2500 files before the next run of <code>apt_queue_fixity</code>, which then queues incomplete the GenericFile IDs again.</p>
</li>
<li>
<p>In all other topics, NSQ may not hear back from a worker before NSQ's internal timeout. NSQ thinks the worker is stuck or dead, so it requeues the WorkItem ID itself. This is most likely to happen when long-running operations like <code>ingest_pre_fetch</code>, <code>ingest_format_identifier</code> and <code>ingest_preservation_uploader</code> are dealing with huge files.</p>
</li>
</ol>
<p>The solutions to these issues are:</p>
<ol>
<li>
<p>The <code>apt_fixity</code> checks the LastFixity timestamp on each GenericFile before it actually starts work. If the file was just checked, it tells NSQ the task is complete and logs a message saying it's skipping that file because it was recently checked.</p>
</li>
<li>
<p>All other workers fetch a copy of the WorkItem from the Registry before they go to work. If the WorkItem Node is non-empty, the process knows some worker is already on it, and it skips the task. Workers also check a number of other properties on the WorkItem to ensure the item is in the right stage of processing, has not completed or been cancelled, has the Retry flag set to true, etc.</p>
</li>
</ol>
<p>For more info, search the code repo for <code>ShouldSkipThis</code>. You'll find various methods in various packages, since the logic for what's to be skipped differs according to what's being done. All ingest workers share the same skip logic. Bag restoration, file restoration, Glacier restoration and deletion have their own logic, but regardless of the worker, the function is always called <code>ShouldSkipThis</code></p>
<h2 id="queue-settings-in-aws-parameter-store">Queue Settings in AWS Parameter Store</h2>
<p>Each worker pulls three performance tuning parameters from Parameter Store. The settings are listed below. Descriptions of the settings appear below.</p>
<table>
<thead>
<tr>
<th>Queue Topic</th>
<th>Settings</th>
</tr>
</thead>
<tbody>
<tr>
<td>delete_item</td>
<td>APT_DELETE_BUFFER_SIZE, APT_DELETE_WORKERS, APT_DELETE_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>fixity_check</td>
<td>APT_FIXITY_BUFFER_SIZE, APT_FIXITY_WORKERS, APT_FIXITY_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>ingest01_prefetch</td>
<td>INGEST_PRE_FETCH_BUFFER_SIZE, INGEST_PRE_FETCH_WORKERS, INGEST_PRE_FETCH_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>ingest02_bag_validation</td>
<td>INGEST_VALIDATOR_BUFFER_SIZE, INGEST_VALIDATOR_WORKERS, INGEST_VALIDATOR_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>ingest03_reingest_check</td>
<td>REINGEST_MANAGER_BUFFER_SIZE, REINGEST_MANAGER_WORKERS, REINGEST_MANAGER_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>ingest04_staging</td>
<td>INGEST_STAGING_UPLOADER_BUFFER_SIZE, INGEST_STAGING_UPLOADER_WORKERS, STAGING_UPLOADER_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>ingest05_format_identification</td>
<td>INGEST_FORMAT_IDENTIFIER_WORKERS, INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE, INGEST_FORMAT_IDENTIFIER_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>ingest06_storage</td>
<td>INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE, INGEST_PRESERVATION_UPLOADER_WORKERS, INGEST_PRESERVATION_UPLOADER_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>ingest07_storage_validation</td>
<td>INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE, INGEST_PRESERVATION_VERIFIER_WORKERS, INGEST_PRESERVATION_VERIFIER_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>ingest08_record</td>
<td>INGEST_RECORDER_BUFFER_SIZE, INGEST_RECORDER_WORKERS, INGEST_RECORDER_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>ingest09_cleanup</td>
<td>INGEST_CLEANUP_BUFFER_SIZE, INGEST_CLEANUP_WORKERS, INGEST_CLEANUP_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>restore_file</td>
<td>FILE_RESTORER_BUFFER_SIZE, FILE_RESTORER_WORKERS, FILE_RESTORER_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>restore_glacier</td>
<td>GLACIER_RESTORER_BUFFER_SIZE, GLACIER_RESTORER_WORKERS, GLACIER_RESTORER_MAX_ATTEMPTS</td>
</tr>
<tr>
<td>restore_object</td>
<td>BAG_RESTORER_BUFFER_SIZE, BAG_RESTORER_WORKERS, BAG_RESTORER_MAX_ATTEMPTS</td>
</tr>
</tbody>
</table>
<h3 id="workers-setting">Workers Setting</h3>
<p>Params ending in <code>WORKERS</code> describe the number of go routines a worker should use to do its work. A setting of 3 indicates 3 go routines, which means the worker can process three NSQ WorkItems simultaneously. (Think of a Java or C++ app running three independent threads at all times, with each thread capable of handing an NSQ task from stat to finish.)</p>
<p>Because our workers run in very small containers with &gt;512 MB of RAM, we tend to limit the number of workers to 2, or in some cases, such as the format identifier, to 1. (The format identifier uses a lot of memory, and more than one concurrent go routine can cause it to crash with an out-of-memory exception.)</p>
<p>When running in larger containers, you can increase the number of workers. Note, however, that <code>ingest_preservation_uploader</code> can also use a lot of memory and can crash if you set the number of workers too high.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>It's generally not a good idea to set the number of workers for
ingest_recorder above 2. This worker issues a huge number of
requests to the Registry at the end of the ingest process. Too many
recorders can make the Registry very slow, or can cause it to
scale out to more containers than we really need to run.</p>
<p>It's better (and likely just as fast) to keep these items queued
in the record topic than to have hundreds of requests stuck in
Registry's TCP buffers.</p>
</div>
<h3 id="buffer-size-setting">Buffer Size Setting</h3>
<p>Params ending in <code>BUFFER_SIZE</code> describe the number of NSQ messages to hold in each worker's internal queue. This setting has some interesting ramifications for scaling.</p>
<p>Let's say you set <code>BUFFER_SIZE</code> to 10 for the <code>ingest_staging_uploader</code>, and you also set the number of workers for <code>ingest_staging_uploader</code> to 2. Each of the ingest validator's two go routines will tell NSQ it's ready to accept 10 items. Assuming NSQ has that many items, it will give 20 tasks to <code>ingest_staging_uploader</code> all at once, and <strong>it will wait until the each go routine has finished its set of 10 before it hands that go routine 10 more.</strong></p>
<p>This last point is important for scaling. Let's say a worker gets 20 items from NSQ and its CPU and RAM usage go straight to 100%. This will trigger our ECS auto-scaler to add a new <code>ingest_staging_uploader</code> container.</p>
<p>However, the first container will not relinquish the batch of 20 files it's working on, and it's possible that the new container will have nothing to work on at all. In this case, container 1 may continue to max out all its resources for several hours, while container 2 remains idle.</p>
<p>For this reason, we tend to set <code>BUFFER_SIZE</code> to a low number (3-5) for our long-running, resource-intensive workers. The following workers are resource-intensive and/or long-running, and should have relatively small buffer sizes:</p>
<table>
<thead>
<tr>
<th>Worker</th>
<th>Heavily Used Resource</th>
</tr>
</thead>
<tbody>
<tr>
<td>apt_fixity</td>
<td>High network I/O when fetching files from S3. High CPU usage when calculating checksums.</td>
</tr>
<tr>
<td>bag_restorer</td>
<td>High network I/O when fetching files from S3. High CPU usage when calculating checksums.</td>
</tr>
<tr>
<td>file_restorer</td>
<td>High network I/O when fetching files from S3. High CPU usage when calculating checksums.</td>
</tr>
<tr>
<td>ingest_format_identifier</td>
<td>High network I/O and CPU. Extremely high memory.</td>
</tr>
<tr>
<td>ingest_pre_fetch</td>
<td>High network I/O when fetching files from S3. High CPU usage when calculating checksums.</td>
</tr>
<tr>
<td>ingest_preservation_uploader</td>
<td>High network I/O. When uploading very large files, high memory usage for upload buffers.</td>
</tr>
<tr>
<td>ingest_staging_uploader</td>
<td>High network I/O. When uploading very large files, high memory usage for upload buffers.</td>
</tr>
</tbody>
</table>
<p>The remaining workers tend to finish to their tasks quickly, often in seconds, so they can tolerate higher buffer sizes.</p>
<h3 id="max-attempts-setting">Max Attempts Setting</h3>
<p>The <code>MAX_ATTEMPTS</code> settings describe how many times a worker should retry an NSQ task before giving up due to transient errors. Transient errors almost always fall into two categories:</p>
<ol>
<li>Network problems, such as <code>timeout</code> or <code>connection reset by peer</code></li>
<li>Unavailable remote services, such S3, Glacier, Wasabi, Redis, NSQ or Registry responding with <code>HTTP 503 (Service Unavailable)</code> or not responding at all.</li>
</ol>
<p>Of the errors above, #1 accounts for more than 99% of cases.</p>
<p>When a task fails due to transient errors, the worker requeues it. After requeuing it <code>MAX_ATTEMPS</code> times, the worker stops trying to complete the task and does the following:</p>
<ol>
<li>Marks the taks as failed in NSQ.</li>
<li>Logs specific information about why it's quitting.</li>
<li>Updates the WorkItem in Registry, setting:<ol>
<li>Retry = false</li>
<li>NeedsAdminReview = true</li>
<li>Note = Detailed information about what happened and why the worker won't complete the task.</li>
</ol>
</li>
</ol>
<p>An APTrust admin can easily find these items in the Registry by search for WorkItems where NeedsAdminReview = true. The admin can then requeue them if he/she knows the underlying issue is resolved.</p>
<p>When these issues do occur, they are almost always network errors and it makes no sense to requeue this items until we know the network has recovered.</p>
<h2 id="fatal-errors">Fatal Errors</h2>
<p>The only fatal errors that will cause workers to permenantly give up on an item are:</p>
<ul>
<li>Invalid bags. These occasinally appear in depositors' receiving buckets. We can't process them, so we don't. Invalid bags may remain in the receiving buckets for up to 14 days, so we and the depositors can examine them. Their interim processing data may persist in Redis as well, for diagnostic/forensic purposes. APTrust admins must manually delete the Redis data.</li>
<li>Files missing from preservation. This has never happened, but if it were to happen, restoration and deletion processes would log a fatal error and set the NeedsAdminReview flag on the appropriate WorkItem. The APTrust admin will have to manually investigate the issue.</li>
<li>Invalid restoration package. This would happen if the object restorer reassembled a bag for restoration and then found the bag was invalid. This has never happened. Once again, this would require a manual investigation by an APTrust admin.</li>
</ul>
<h2 id="nsq-admin-functions">NSQ Admin Functions</h2>
<p>All NSQ admin features are available to APTrust admins through the Registry UI. Features include starting, pausing, deleting and emptying topics and channels.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The most graceful way to stop all processing in the system is to pause
all of the topics and channels. The workers will complete the items in
their internal go routine queues and will then sit idle.</p>
<p>The Registry UI includes a feature to pause and unpause all topics
and/or channels at once. When paused, topics will continue to queue
new tasks, but will not pass those tasks out to workers. When you
unpause the topics and channels, workers will resume work immediately.</p>
</div>
<h2 id="manually-requeuing">Manually Requeuing</h2>
<p>The Registry UI allows APTrust admins to manually requeue any item that has not completed processing. (I.e. You can requeue a completed ingest, restoration, or deletion. There's no point.)</p>
<p>To requeue an item, go to it's WorkItem detail page and click the Requeue button. You should generally requeue to the last attempted stage of processing, which is pre-selected in the UI. The APTrust admin may requeue to any earlier stage of processing if he/she thinks that's appropriate.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../redis/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Redis" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Redis
            </div>
          </div>
        </a>
      
      
        
        <a href="../registry/" class="md-footer__link md-footer__link--next" aria-label="Next: Registry" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Registry
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.8492ddcf.min.js"></script>
      
    
  </body>
</html>
# NSQ

NSQ is the queue service that tells all our workers what tasks need to be completed. This includes ingest, restoration, deletion and fixity workers.

NSQ includes topics and channels. A topic holds a list of tasks that need to be completed. Each topic can have one or more channels. Workers subscribe to channels to get their work. In Preserv, each topic has only one channel, and workers subscribe to channels as described in the table below.

The `source` column describes how items get into this queue. The `content` column describes what's in the queue message. When the content is a WorkItem ID, the worker pulls a copy of the WorkItem from the Registry, marks it as "in progress" and begins its work. When the the content is a GenericFile ID, the worker retrieves the GenericFile record from the Registry, runs a fixity check, and records the outcome in a Premis Event withouth ever creating a WorkItem.

Topic | Worker | Content|  Purpose | Source
----- | ------ | ------- | ------- | ------
delete\_item | apt\_delete | WorkItem ID | Deletes files and/or objects from preservation storage and records deletion Premis Event. | Deletions are pushed into the queue by the Registry when they're approved by an institutional admin. The apt\_queue service runs periodically to catch any deletion and restoration requests that may not have made it from Registry to NSQ due to network errors.
fixity\_check | apt\_fixity | GenericFile ID | Tells apt\_fixity which files to check. | The apt\_queue_fixity process pushes about 2500 files into this queue every 20-30 minutes. The exact number and frequency are defined by params `QUEUE_FIXITY_INTERVAL` and `MAX_FIXITY_ITEMS_PER_RUN`, both of which are in AWS Parameter Store.
ingest01\_ prefetch | ingest\ _pre\_ fetch | WorkItem ID | Scans new bags in depositors' receiving buckets and collects metadata for bag validation. | The ingest\_bucket\_reader, a cron job running in its own container, checks the buckets every few minutes. When it finds new bags with no associated WorkItem, it creates a new Ingest WorkItem in the Registry and pushes the WorkItem ID into this queue.
ingest02\ _bag\_ validation | ingest\_ validator | WorkItem ID | Validates a bag to ensure all files are present, all checksums match, no extraneous payload files exist, and the bag conforms to the BagIt profile noted in bag-info.txt. | The ingest\_pre\_fetch worker pushes WorkItem IDs into this queue for each item it successfully processes.
ingest03\_ reingest\_ check | reingest\_ manager | WorkItem ID | Checks files in the bag against known files in the Registry to see if any of them are re-ingests. See the [reingest manager page](/workers/ingest/reingest-manager/) for more info. | Filled by ingest\_validator.
ingest04\_ staging | ingest\_ staging\_ uploader | WorkItem ID | Unpacks tarred bags from depositor receiving buckets and uploads the individual files to an S3 staging bucket so subsequent workers can process them. | Filled by reingest\_manager.
ingest05\_ format\_ identification | ingest\_ format\_ identifier | WorkItem ID | Runs individual files from the staging bucket through the Siegfried file identifier, which uses the PRONOM registry under the hood to identify file formats. | Filled by ingest\_ staging\_ uploader.
ingest06\_ storage | ingest\_ preservation\_ uploader | WorkItem ID | Copies individual files from the S3 staging bucket to preservation storage in S3, Glacier, and/or Wasabi. | Filled by ingest\_ format\_ identifier.
ingest07\_ storage\ _validation | ingest\_ preservation\_ verifier | WorkItem ID | Verifies that items copied to preservation storage actually got there by performing a HEAD request and ensuring file size matches. | Filled by ingest\_ preservation\_ uploader.
ingest08\_ record | ingest\_ recorder | WorkItem ID | Records the results of an ingest in Registry. This includes the object record, file records, storage records, checksums, and premis events. | Filled by ingest\_ preservation\_ verifier.
ingest09\_ cleanup | ingest\_ cleanup | WorkItem ID | Deletes interim processing data, including the tarred bag in the depositor's receiving bucket, the individual files in the staging bucket, and the processing metadata in Redis/Elasticache. | Filled by ingest\_recorder.
restore\_ file | file\_ restorer | WorkItem ID | Restores individual files by moving them from preservation storage to the depositor's restoration bucket. | Filled by Registry when a user clicks the `Restore File` button, with backup from `apt_queue` in case Registry queueing fails. This topic can also be filled by restore\_glacier worker when it determines that a Glacier file has been moved into an S3 bucket for retrieval.
restore\_ glacier | glacier\_ restorer | WorkItem ID | Moves files from Glacier and Glacier Deep Archive into an S3 bucket so they can be restored to depositors. | Filled by Registry when a user clicks the `Restore File` button for an object in Glacier or Glacier Deep Archive. Registry queueing fails, `apt_queue` will find the item and queue it.
restore\_ object | bag\_ restorer | WorkItem ID | Restores entire objects (bags) to depositors by collecting all files, bagging them, validating the bag, and pushing it into the depositor's restoration bucket. | Filled by Registry when a user clicks the `Restore File` button, with backup from `apt_queue` in case Registry queueing fails. This topic can also be filled by restore\_glacier worker when it determines that all of a bag's Glacier files have been moved into an S3 bucket for retrieval.
